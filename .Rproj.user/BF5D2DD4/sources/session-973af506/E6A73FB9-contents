rm(list=ls())
# Hypothesis testing 
library(tidyverse)
library(lme4)
library(lmerTest)
library(nlme)
library(ggeffects)
library(cowplot)
library(ggsci)
library(MuMIn)

setwd("/Volumes/GoogleDrive/My Drive/EXTINCT/EXTINCT/DB_worked")
setwd("~/Library/CloudStorage/GoogleDrive-yolrem@gmail.com/My Drive/EXTINCT/EXTINCT/DB_worked")
# Does pop change in relation to the anomalies change differently for local - global adapted spp in interaction with the posiion in the range?

#load in masterdatasheet
butterflydata<-read.delim("NewMastersheet_YM_16August.txt", sep="\t")
summary(butterflydata)
list(unique(butterflydata$species))
### BE AWARE SOME SP RESPONDE TO ANOMALIES OF THE PERIOD OF THE PREVIOUS YEAR t-1 !
butterflydata.t_1<- filter(butterflydata, Time =="t-1")
butterflydata.t_1<-droplevels(butterflydata.t_1)
butterflydata.t_1<- data.frame(butterflydata %>% 
                                 group_by(species, site) %>%
                                 mutate(local.anomaly2 = lag(local.anomaly, order_by = year)))
butterflydata.t<- filter(butterflydata, Time !="t-1")
butterflydata.t<-droplevels(butterflydata.t)
butterflydata.t$local.anomaly2<-butterflydata.t$local.anomaly
butterflydata<-rbind(butterflydata.t, butterflydata.t_1)      
rm(list=setdiff(ls(), c("butterflydata")))

# remove NAs 
butterflydatadens <-filter(butterflydata, !is.na(gamdens))
butterflydatadens <-filter(butterflydatadens, gam_index!=0)
butterflydatadens <-filter(butterflydatadens, (gamdens != Inf))
butterflydatadens <-filter(butterflydatadens, (n_change != -Inf))
butterflydatadens$logNt <- log(butterflydatadens$Nt)

#subset those species with n-shaped response in the Pop change vs climatic anomaly from paper MS1
butterflydatadens2<-subset(butterflydatadens, butterflydatadens$species=="Argynnis adippe" 
                           | butterflydatadens$species=="Aricia agestis"  |
                             butterflydatadens$species=="Aricia artaxerxes" |
                             butterflydatadens$species=="Boloria dia" |
                             butterflydatadens$species=="Boloria euphrosyne" |
                             butterflydatadens$species=="Brenthis daphne" |
                             butterflydatadens$species=="Brenthis ino" |
                             butterflydatadens$species=="Charaxes jasius" |
                             butterflydatadens$species=="Colias croceus" |
                             butterflydatadens$species=="Cupido osiris" |
                             butterflydatadens$species=="Laeosopis roboris" |
                             butterflydatadens$species=="Leptidea juvernica" | #??
                             butterflydatadens$species=="Leptidea sinapis" |
                             butterflydatadens$species=="Lycaena phlaeas" |
                             butterflydatadens$species=="Lycaena virgaureae" |
                             butterflydatadens$species=="Lysandra coridon" |
                             butterflydatadens$species=="Lysandra hispana" |
                             butterflydatadens$species=="Melanargia galathea" | #?
                             butterflydatadens$species=="Nymphalis polychloros" |
                             butterflydatadens$species=="Ochlodes sylvanus" |
                             butterflydatadens$species=="Papilio machaon" |
                             butterflydatadens$species=="Pararge aegeria" |
                             butterflydatadens$species=="Parnassius apollo" | #?
                             butterflydatadens$species=="Pieris brassicae" | #?
                             butterflydatadens$species=="Plebejus idas" |
                             butterflydatadens$species=="Polyommatus icarus" |
                             butterflydatadens$species=="Pseudophilotes panoptes" |
                             butterflydatadens$species=="Pyrgus malvae" | 
                             butterflydatadens$species=="Satyrium acaciae" | 
                             butterflydatadens$species=="Satyrium esculi" | 
                             butterflydatadens$species=="Satyrium pruni" | 
                             butterflydatadens$species=="Satyrium spini" | #??? 
                             butterflydatadens$species=="Thymelicus acteon" | #?
                             butterflydatadens$species=="Thymelicus lineola" )
butterflydatadens2<-droplevels(butterflydatadens2, drop=T)          
unique(levels(butterflydatadens2$species)) 
head(butterflydatadens2)


butterflydatadens.global<-filter(butterflydatadens2, Scale2 =="Global")
butterflydatadens.global<-droplevels(butterflydatadens.global)
summary(butterflydatadens.global)
butterflydatadens.local<-filter(butterflydatadens2, Scale2 =="Local")
butterflydatadens.local<-droplevels(butterflydatadens.local)
summary(butterflydatadens.local)
butterflydatadens.local2<-filter(butterflydatadens.local, Degree.Local.Adaptation <= 0.6)
#rm(butterflydata, butterflydatadens, butterflydatadens2)


par(mfrow = c(1, 2),     # 1x2 layout
    oma = c(2, 2, 0, 0), # two rows of text at the outer left and bottom margin
    mar = c(1, 2, 1, 1), # space for one row of text at ticks and to separate plots
    mgp = c(2, 1, 0),    # axis label at 2 rows distance, tick labels at 1 row
    xpd = NA) 
boxplot(butterflydatadens.global$Degree.Local.Adaptation, butterflydatadens.local$Degree.Local.Adaptation,
        names=c("Global","Local"),ylab= "Degree of local adaptation", xlab = "Species category", col = c("blue", "orange"))
boxplot(butterflydatadens.global$Degree.Local.Adaptation, butterflydatadens.local2$Degree.Local.Adaptation,
        names=c("Global","Local"),ylab= "", xlab = "Species category", col = c("blue", "orange"))
legend(-2.05,0.064, "(a)", box.lty=0, bg="transparent", cex= 0.8)
legend(0.4,0.064, "(b)", box.lty=0, bg="transparent", cex= 0.8)
rm(butterflydatadens.local2)

###  ANOMALIES ###
########## MODELS FOR GLOBAL SP ALL DATA MAIN MS########
# all data
rangerepintnum2.g.gl<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species) +(1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.global)
AIC(rangerepintnum2.g.gl) 
summary((rangerepintnum2.g.gl))
# take a look at fit for sample of species 
mydf.g <- ggpredict(rangerepintnum2.g.gl, terms = c( "local.anomaly[all]","rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))

#style option 1A (colors from blue, green, to red)
#plot1<-
  ggplot(mydf.g, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ 
  scale_color_hue(direction = -1,h= c(100, 360))+ 
  #scale_color_brewer(palette = "RdYlBu")
  #scale_colour_manual(values = rainbow(943)) +
  #scale_color_gradient2(midpoint=0, low="purple", mid="green",
   #                     high="red")+
  annotate("text", x = -5, y = 0.9, label = "(e)")+
  ylab("Population change")+ 
  xlab("Climatic anomaly of the year") + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"))

#style option 1B (colors from blue to yellow to red with lines)
mydf.gB <- ggpredict(rangerepintnum2.g.gl, terms = c( "local.anomaly[all]",
                                                     "rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))
plot1B<-ggplot(mydf.gB, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ 
  scale_color_hue(direction = -1,h= c(100, 360))+ 
  #scale_color_brewer(palette = "RdYlBu")
  #scale_colour_manual(values = rainbow(943)) +
  #scale_color_gradient2(midpoint=0, low="purple", mid="green",
  #                     high="red")+
  annotate("text", x = -5, y = 0.9, label = "(e)")+
  ylab("Population change")+ 
  xlab("Climatic anomaly of the year") + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"))

#style option 1C (colors from blue to red)
plot1C<-ggplot(mydf.gB, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ xlim(c(-4,6))+
  scale_color_manual(values=rev(c("#FF0000FF","#FF0000FF", "#FF2A00FF" ,"#FF5500FF" ,"#FF8000FF" ,"#FFAA00FF" ,"#FFD500FF",
                                  "#FFFF00FF" ,"#FFFF40FF", "#FFFFBFFF", "#FFFFBFFF", "#F7FBFF" ,"#DEEBF7" ,"#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5",
                                  "#08519C", "#08306B","#08306B")))+
  annotate("text", x = -3.7, y = 0.45, label = "(b) Globally adapted species",vjust = 0.5, hjust = 0)+
  ylab("")+ 
  xlab("Climatic anomaly of the year") + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"))  

########## MODELS FOR LOCAL SP ALL DATA MAIN MS########
#quadratic
#Shouldn't this actually respond to the local anomalies
#all data
rangerepintnum2.l.g<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species)+ (1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.local)
AIC(rangerepintnum2.l.g)
summary(rangerepintnum2.l.g)
# take a look at fit for sample of species 
mydf.l1 <- ggpredict(rangerepintnum2.l.g, terms = c( "local.anomaly[all]","rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))
mydf.l1<-subset(mydf.l1, mydf.l1$x > -6.5 & mydf.l1$x < 3.5)
mydf.l1<-droplevels(mydf.l1)
plot5<-  ggplot(mydf.l1, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ xlim(c(-7,5))+
  scale_color_manual(values=rev(c("#FF0000FF","#FF0000FF", "#FF2A00FF" ,"#FF5500FF" ,"#FF8000FF" ,"#FFAA00FF" ,"#FFD500FF",                                   "#FFFF00FF" ,"#FFFF40FF", "#FFFFBFFF", "#FFFFBFFF", "#F7FBFF" ,"#DEEBF7" ,"#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5",                                   "#08519C", "#08306B","#08306B")))+
  annotate("text", x = -6.7, y = 0.45,  label = expression("(a) Locally adapted species"),   
           vjust = 0.5, hjust = 0) + 
  ylab("Population change")+  
  xlab("Climatic anomaly of the year")  + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"))  

require(gridExtra)
grid.arrange(plot5, plot1C,ncol=2, nrow=1)

########## MODELS FOR LOCAL CONSERVATIVE DATA (SUPP MATERIAL) ########
#quadratic
#what about reduced degree of local adaptation
summary(butterflydatadens.local)
rm(butterflydatadens.local2)
butterflydatadens.local2<-filter(butterflydatadens.local, Degree.Local.Adaptation >= 0.025) # 
butterflydatadens.local2<-droplevels(butterflydatadens.local2)
unique(butterflydatadens.local2$species)
rangerepintnum2.l.g<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species) +(1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.local2)
summary((rangerepintnum2.l.g))
AIC(rangerepintnum2.l.g)
rangerepintnum2.l.g2<-lmer(n_change ~logNt +rangeposition+local.anomaly+I(local.anomaly^2)+(1|species) +(1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.local2)
summary((rangerepintnum2.l.g2))
AIC(rangerepintnum2.l.g2)
modelave<-model.avg(rangerepintnum2.l.g2, rangerepintnum2.l.g)
summary(modelave)

# predict and plot
library(prediction)
library(ggeffects)
rangerepintnum2.l.g3<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species) +(1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.local2)
summary((rangerepintnum2.l.g3))
mydf.l2 <- ggpredict(rangerepintnum2.l.g3, terms = c( "local.anomaly[all]","rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))
mydf.l2<-subset(mydf.l2, mydf.l2$x > -6.7 & mydf.l2$x < 3.2)
plot6<-ggplot(mydf.l2, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ xlim(c(-7,5))+
  scale_color_manual(values=rev(c("#FF0000FF","#FF0000FF", "#FF2A00FF" ,"#FF5500FF" ,"#FF8000FF" ,"#FFAA00FF" ,"#FFD500FF",                                   "#FFFF00FF" ,"#FFFF40FF", "#FFFFBFFF", "#FFFFBFFF", "#F7FBFF" ,"#DEEBF7" ,"#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5",                                   "#08519C", "#08306B","#08306B")))+
  annotate("text", x = -6.7, y = 0.45, label = "(a) Locally adapted species", hjust = 0, vjust = 1)+
  ylab("Population change")+ 
  xlab("") + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"),
        axis.title.x=element_blank())
plot6

##repeat with outlier Apollo parnassius
rm(butterflydatadens.local2)
butterflydatadens.local2<-filter(butterflydatadens.local, Degree.Local.Adaptation < 0.7)
butterflydatadens.local2<-droplevels(butterflydatadens.local2)
unique(butterflydatadens.local2$species)
rangerepintnum2.l.g4<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species)+ (1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.local2)
AIC(rangerepintnum2.l.g4)
summary(rangerepintnum2.l.g4)
mydf.l2 <- ggpredict(rangerepintnum2.l.g4, terms = c( "local.anomaly[all]","rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))
mydf.l2<-subset(mydf.l2, mydf.l2$x > -6.5 & mydf.l2$x < 3.5)
#mydf.l2<-droplevels(mydf.l2)
plot7<-ggplot(mydf.l2, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ xlim(c(-7,5))+
  scale_color_manual(values=rev(c("#FF0000FF","#FF0000FF", "#FF2A00FF" ,"#FF5500FF" ,"#FF8000FF" ,"#FFAA00FF" ,"#FFD500FF",                                   "#FFFF00FF" ,"#FFFF40FF", "#FFFFBFFF", "#FFFFBFFF", "#F7FBFF" ,"#DEEBF7" ,"#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5",                                   "#08519C", "#08306B","#08306B")))+
  annotate("text", x = -6.7, y = 0.45, label = "(b) Locally adapted species", hjust = 0, vjust = 1)+
  ylab("")+ 
  theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"),
        axis.title.x=element_blank())
plot7

#w about reduced degree of local adaptation
butterflydatadens.local23<-filter(butterflydatadens.local2, Degree.Local.Adaptation >= 0.025) # 
butterflydatadens.local23<-droplevels(butterflydatadens.local23)
unique(butterflydatadens.local23$species)
Arangerepintnum2.l.g4<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species)+ (1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.local2)
AIC(Arangerepintnum2.l.g4)
summary(Arangerepintnum2.l.g4)
mydf.l5 <- ggpredict(Arangerepintnum2.l.g4, terms = c( "local.anomaly[all]","rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))
mydf.l5<-subset(mydf.l5, mydf.l5$x > -6.5 & mydf.l5$x < 3.5)
plot8<-ggplot(mydf.l5, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ xlim(c(-7,5))+
  scale_color_manual(values=rev(c("#FF0000FF","#FF0000FF", "#FF2A00FF" ,"#FF5500FF" ,"#FF8000FF" ,"#FFAA00FF" ,"#FFD500FF",                                   "#FFFF00FF" ,"#FFFF40FF", "#FFFFBFFF", "#FFFFBFFF", "#F7FBFF" ,"#DEEBF7" ,"#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5",                                   "#08519C", "#08306B","#08306B")))+
  annotate("text", x = -6.7, y = 0.45, label = "(c) Locally adapted species", hjust = 0, vjust = 1)+
  ylab("")+ 
  xlab("") + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"),
        axis.title.x=element_blank())
plot8

########## MODELS FOR GLOBAL SP CONSERVATIVE DATA (SUPP MATERIAL) ########
#all data but conservative reduced degree of  adaptation
butterflydatadens.global2<-filter(butterflydatadens.global, Degree.Local.Adaptation <= -0.025) # 
butterflydatadens.global2<-droplevels(butterflydatadens.global2)
unique(butterflydatadens.global2$species)
rangerepintnum2.g.gl<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species) +(1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.global2)
AIC(rangerepintnum2.g.gl)
summary((rangerepintnum2.g.gl))
# take a look at fit for sample of species 
mydf.g2 <- ggpredict(rangerepintnum2.g.gl, terms = c( "local.anomaly[all]",
                                                      "rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))
plot2<-ggplot(mydf.g2, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ xlim(c(-4,6))+
  scale_color_manual(values=rev(c("#FF0000FF","#FF0000FF", "#FF2A00FF" ,"#FF5500FF" ,"#FF8000FF" ,"#FFAA00FF" ,"#FFD500FF",
                                  "#FFFF00FF" ,"#FFFF40FF", "#FFFFBFFF", "#FFFFBFFF", "#F7FBFF" ,"#DEEBF7" ,"#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5",
                                  "#08519C", "#08306B","#08306B")))+
  annotate("text", x = -3.7, y = 0.45, label = "(d) Globally adapted species", hjust = 0, vjust = 1)+
  ylab("Population change")+ 
  xlab("Climatic anomaly of the year") + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"))

##### REPEAT WITHOUT POTNTIAL OUTLIERS
butterflydatadens.global3<-subset(butterflydatadens.global, butterflydatadens.global$Degree.Local.Adaptation> -0.15) #potential outliers
butterflydatadens.global3<-droplevels(butterflydatadens.global3)
unique(butterflydatadens.global3$species)

rangerepintnum2.g.gl<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species) +(1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.global3)
summary(rangerepintnum2.g.gl)
mydf.g3 <- ggpredict(rangerepintnum2.g.gl, terms = c( "local.anomaly[all]","rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))
plot3<-ggplot(mydf.g3, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ xlim(c(-4,6))+
  scale_color_manual(values=rev(c("#FF0000FF","#FF0000FF", "#FF2A00FF" ,"#FF5500FF" ,"#FF8000FF" ,"#FFAA00FF" ,"#FFD500FF",
                                  "#FFFF00FF" ,"#FFFF40FF", "#FFFFBFFF", "#FFFFBFFF", "#F7FBFF" ,"#DEEBF7" ,"#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5",
                                  "#08519C", "#08306B","#08306B")))+
  annotate("text", x = -3.7, y = 0.45, label = "(e) Globally adapted species", hjust = 0, vjust = 1)+
  ylab("")+ 
  xlab("Climatic anomaly of the year") + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"))


butterflydatadens.global23<-filter(butterflydatadens.global3, Degree.Local.Adaptation <= -0.025)
butterflydatadens.global23<-droplevels(butterflydatadens.global23)
unique(butterflydatadens.global23$species)
rangerepintnum2.g.gl<-lmer(n_change ~logNt +rangeposition*local.anomaly+I(local.anomaly^2)+(1|species) +(1|site),control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)) ,REML = T ,data=butterflydatadens.global23)
summary(rangerepintnum2.g.gl)
mydf.g23 <- ggpredict(rangerepintnum2.g.gl, terms = c( "local.anomaly[all]","rangeposition[1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1,0,-0.1,-0.2,-0.3,-0.4,-0.5,-0.6,-0.7,-0.8,-0.9,-1]"))
plot4<-ggplot(mydf.g23, aes(x, predicted, colour = group)) + 
  geom_line(size=1)+ ylim(c(-1, 0.5))+ xlim(c(-4,6))+
  scale_color_manual(values=rev(c("#FF0000FF","#FF0000FF", "#FF2A00FF" ,"#FF5500FF" ,"#FF8000FF" ,"#FFAA00FF" ,"#FFD500FF",
                                  "#FFFF00FF" ,"#FFFF40FF", "#FFFFBFFF", "#FFFFBFFF", "#F7FBFF" ,"#DEEBF7" ,"#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5",
                                  "#08519C", "#08306B","#08306B")))+
  annotate("text", x = -3.7, y = 0.45, label = "(f) Globally adapted species", hjust = 0, vjust = 1)+
  ylab("Population change")+ 
  xlab("Climatic anomaly of the year") + theme_bw()+ theme(legend.position = "none")+
  theme(panel.grid = element_blank(),panel.border = element_blank(),axis.line = element_line(colour = "black"))

#rm(list=setdiff(ls(), c("butterflydatadens.local", "plot1", "plot2", "plot3", "plot4", "plot5", "plot6", "plot7", "plot8")))
grid.arrange(plot6, plot7, plot8, plot2, plot3, plot4, ncol=3, nrow=2)

